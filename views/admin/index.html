{{define "admin/index.html"}}
<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Webstack.cc" />
    <meta name="author" content="viggoz.com" />
    <title>后台管理 - {{.config.Title}}</title>
    <link rel="shortcut icon" href="./assets/images/favicon.png">
    <link rel="stylesheet" href="assets/css/fonts/linecons/css/linecons.css">
    <link rel="stylesheet" href="assets/css/fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/xenon-core.css">
    <link rel="stylesheet" href="assets/css/xenon-forms.css">
    <link rel="stylesheet" href="assets/css/xenon-components.css">
    <link rel="stylesheet" href="assets/css/xenon-skins.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <script src="assets/js/jquery-1.11.1.min.js"></script>
</head>

<style>
    .panel-body p{
        text-indent:2em;
    }

    .list-class-title div{
        font-size: 15px;
        color: #000;
    }

    .list-class-title ul{
        margin-top: 10px;
        margin-bottom: 0px;
    }

    .list-class-item{
        background-color: #eee;
    }

    .list-class-item-action{
        background-color: #fcf8e3; !important;
    }

    #web-image {
        background-position: center;
        background-repeat: no-repeat;
        background-size: 150px;
        border-style: none;
    }

    a.add {
        font-size: 13px;
        color: #40bbea;
    }

    a.edit {
        font-size: 13px;
        color: #8dc63f;
    }

    a.delete {
        font-size: 13px;
        color: #cc3f44;
    }

</style>

<body class="page-body">
    <div class="page-loading-overlay">
        <div class="loader-2"></div>
    </div>
    <div class="page-container">
        <div class="sidebar-menu toggle-others fixed">
            <div class="sidebar-menu-inner">
                <header class="logo-env">
                    <!-- logo -->
                    <div class="logo">
                        <a href="" class="logo-expanded">
                            <img src="assets/images/logo@2x.png" width="100%" alt="" />
                        </a>
                        <a href="" class="logo-collapsed">
                            <img src="assets/images/logo-collapsed@2x.png" width="40" alt="" />
                        </a>
                    </div>
                    <!-- This will toggle the mobile menu and will be visible only on mobile devices -->
                    <div class="mobile-menu-toggle visible-xs">
                        <a href="#" data-toggle="user-info-menu">
                            <i class="fa-bell-o"></i>
                        </a>
                        <a href="#" data-toggle="mobile-menu">
                            <i class="fa-bars"></i>
                        </a>
                    </div>
                </header>
                <ul id="main-menu" class="main-menu">
                    <li class="has-sub active" data-page="admin-index" id="menu-admin-index">
                        <a href="#">
                            <i class="linecons-shop"></i>
                            <span class="title">后台首页</span>
                        </a>
                    </li>
                    <li class="has-sub" data-page="class-config" id="menu-class-config">
                        <a href="#class-config">
                            <i class="linecons-star"></i>
                            <span class="title">分类管理</span>
                            <!-- <span class="badge badge-green">15</span> -->
                        </a>
                    </li>
                    <li class="has-sub" data-page="web-config" id="menu-web-config">
                        <a href="#web-config">
                            <i class="linecons-desktop"></i>
                            <span class="title">网址管理</span>
                        </a>
                    </li>
                    <li class="has-sub" data-page="stack-config" id="menu-stack-config">
                        <a href="#stack-config">
                            <i class="linecons-cog"></i>
                            <span class="title">网站设置</span>
                            <!-- <span class="badge badge-green">7</span> -->
                        </a>
                    </li>
                    <li class="has-sub" data-page="user-config" id="menu-user-config">
                        <a href="#user-config">
                            <i class="linecons-user"></i>
                            <span class="title">用户设置</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="main-content">
            <nav class="navbar user-info-navbar navbar-static-top" role="navigation">
                <!-- User Info, Notifications and Menu Bar -->
                <!-- Left links for user info navbar -->
                <ul class="user-info-menu left-links list-inline list-unstyled">
                    <li class="hidden-sm hidden-xs">
                        <a href="#" data-toggle="sidebar">
                            <i class="fa-bars"></i>
                        </a>
                    </li>
                </ul>
                <!-- Right links for user info navbar -->
                <ul class="user-info-menu right-links list-inline list-unstyled">
                    <li class="dropdown user-profile">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <img src="assets/images/user-4.png" alt="user-image" class="img-circle img-inline userpic-32" width="28" />
                            <span>
								{{.login.Username}}
								<i class="fa-angle-down"></i>
							</span>
                        </a>
                        <ul class="dropdown-menu user-profile-menu list-unstyled">
                            <li>
                                <a href="./index.html" target="_blank">
                                    <i class="fa-home"></i> 主页
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" onclick="menu('user-config')">
                                    <i class="fa-wrench"></i> 设置
                                </a>
                            </li>
                            <li class="last">
                                <a href="javascript:void(0);" onclick="logout()">
                                    <i class="fa-lock"></i> 注销
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="page" id="admin-index">
                <div class="page-title">
                    <div class="title-env">
                        <h1 class="title">首页</h1>
                        <p class="description">后台首页介绍关于此项目的有关内容</p>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">关于项目</h3>
                    </div>
                    <div class="panel-body">
                        <p class="text-left">此项目《<a href="https://github.com/xiaoxinpro/WebStackGo" target="_blank">WebStackGo</a>》是基于<a href="https://github.com/WebStackPage/WebStackPage.github.io" target="_blank">WebStack</a>开源项目二次开发而来的一款轻量级网址导航网站。</p>
                        <p class="text-left">前端保留WebStack原始UI与网址，后端采用Go语言的Gin框架，数据结构采用JSON格式保存在服务端。</p>
                        <p class="text-left">后台同样使用<a href="https://github.com/WebStackPage/webstack-Admin" target="_blank">WebStack-Admin</a>半成品UI设计，根据实际后台功能进行了二次开发与优化。</p>
                        <p class="text-left">关于开源协议，本项目延续WebStack项目的 <strong>MIT</strong> 协议，任何人可以下载使用或二次开发，但请注明本项目开源地址。</p>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">关于作者</h3>
                    </div>
                    <div class="panel-body">
                        <p class="text-left">Github：<a href="https://github.com/xiaoxinpro" target="_blank">https://github.com/xiaoxinpro</a></p>
                        <p class="text-left">Email：pro@xxgzs.org</p>
                        <p class="text-left">如果你有更好的想法，可以通过邮件与我联系，欢迎与我交流分享。</p>
                    </div>
                </div>
            </div>
            <div class="page" id="class-config" style="display: none;">
                <div class="page-title" style="margin-bottom: 12px;">
                    <div class="title-env">
                        <h1 class="title">分类管理</h1>
                        <p class="description">网址分类和首页左侧菜单结构管理。</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-info btn-lg btn-block" data-toggle="modal" data-target="#modal-class-edit" data-backdrop="static" data-class="add" data-index="-1">添加</button>
                    </div>
                    <div class="col-sm-3 col-sm-offset-7 col-md-2 col-md-offset-8">
                        <button type="button" class="btn btn-success btn-lg btn-block" id="class-save-sort" data-loading-text="保存中..."style="display: none;">保存排序</button>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" id="adminWebSortByClass" class="btn btn-info btn-lg btn-block" data-loading-text="加载中...">依据分类顺序排序</button>
                    </div>
                </div>
                <script type="text/javascript">
                    $("#adminWebSortByClass").on('click', function () {
                        let $btn = $(this).button('loading');
                        submit("?cmd=web-sort-by-class", {}, function (res) {
                            $btn.button('reset');
                            if (res['error'] === 0) {
                                message('成功', res['message'], function () {
                                    reload();
                                });
                            } else {
                                message('错误', res['message']);
                            }
                        });
                    })
                </script>
                <ul class="list-group nested-sortable" id="menu-table">
                    {{range $index,$menu := .webstack.Menu}}
                        {{if eq $menu.Menu "smooth"}}
                            <li class="list-group-item list-class-title list-class-has-sub" data-id="{{$menu.Name}}">
                                <div class="">
                                    <i class="{{$menu.Icon}}"></i>
                                    <span class="title">{{$menu.Name}}</span>
                                    <div class="pull-right">
                                        <a href="#" class="add" data-toggle="modal" data-target="#modal-class-edit" data-backdrop="static" data-class="add" data-index="{{$index}}"><i class="linecons-paper-plane"></i>添加</a>&nbsp;
                                        <a href="#" class="edit" data-toggle="modal" data-target="#modal-class-edit" data-backdrop="static" data-class="edit" data-index="{{$index}}"><i class="linecons-pencil"></i>编辑</a>&nbsp;
                                        <a href="#" class="delete" data-toggle="modal" data-target="#modal-class-delete" data-backdrop="static" data-index="{{$index}}"><i class="linecons-trash"></i>删除</a>
                                    </div>
                                </div>
                                {{if $menu.Sub}}
                                <ul class="list-group nested-sortable" data-id="{{$menu.Name}}">
                                    {{range $indexSub,$menuSub := $menu.Sub}}
                                        <li class="list-group-item list-class-item" data-id="{{$menuSub.Name}}">
                                            <span class="title">{{$menuSub.Name}}</span>
                                            <div class="pull-right">
                                                <a href="#" class="edit" data-toggle="modal" data-target="#modal-class-edit" data-backdrop="static" data-class="edit" data-index="{{$index}}-{{$indexSub}}"><i class="linecons-pencil"></i>编辑</a>&nbsp;
                                                <a href="#" class="delete" data-toggle="modal" data-target="#modal-class-delete" data-backdrop="static" data-index="{{$index}}-{{$indexSub}}"><i class="linecons-trash"></i>删除</a>
                                            </div>
                                        </li>
                                    {{end}}
                                </ul>
                                {{end}}
                            </li>
                        {{else}}
                            <li class="list-group-item list-class-title">
                                <div>
                                    <i class="{{$menu.Icon}}"></i>
                                    <span class="title">{{$menu.Name}}</span>
                                    <!-- <div class="pull-right">
                                        <a href="#" class="edit"><i class="linecons-pencil"></i>编辑</a>&nbsp;
                                        <a href="#" class="delete"><i class="linecons-trash"></i>删除</a>
                                    </div> -->
                                </div>
                            </li>
                        {{end}}
                    {{end}}
                </ul>
                <script type="text/javascript">
                    var SortClassData = [];
                    function findMenuItem(webMenu, name) {
                        let ret = null;
                        for (const item in webMenu) {
                            if (webMenu[item]['name'] == name) {
                                return webMenu[item];
                            } else if(webMenu[item]['sub'].length > 0) {
                                ret = findMenuItem(webMenu[item]['sub'], name);
                                if (ret != null) {
                                    return ret;
                                }
                            }
                        }
                        return null;
                    }

                    function findClassItem(webClass, name) {
                        for (const item in webClass) {
                            if (webClass[item].name == name) {
                                return webClass[item];
                            }
                        }
                        return null;
                    }

                    const isString = val => typeof val === 'string';

                    $("#class-save-sort").on('click', function () {
                        let $btn = $(this).button('loading');
                        let table = $("#menu-table");
                        let sortClassData = [];
                        let sortMenuData = [];
                        let sortData = SortClassData[0].toArray();
                        for(let i=1; i < SortClassData.length; i++) {
                            let id = sortData.indexOf(SortClassData[i].el.dataset.id);
                            let name = sortData[id]
                            sortData[id] = {}
                            sortData[id][name] = SortClassData[i].toArray();
                        }
                        // console.log(sortData);
                        for (const item in sortData) {
                            let ret = null;
                            if (isString(sortData[item])) {
                                ret = findMenuItem(WebStack["Menu"], sortData[item]);
                                if(ret != null) {
                                    sortMenuData.push(ret);
                                }
                                ret = findClassItem(WebStack["Class"], sortData[item]);
                                if(ret != null) {
                                    sortClassData.push(ret);
                                }
                            } else {
                                for (const itemName in sortData[item]) {
                                    ret = findMenuItem(WebStack["Menu"], itemName);
                                    if(ret != null) {
                                        let sub = [];
                                        for (const subItem in sortData[item][itemName]) {
                                            let subRet = findMenuItem(ret['sub'], sortData[item][itemName][subItem]);
                                            if(subRet != null) {
                                                sub.push(subRet);
                                            }
                                            subRet = findClassItem(WebStack["Class"], sortData[item][itemName][subItem]);
                                            if(subRet != null) {
                                                sortClassData.push(subRet);
                                            }
                                        }
                                        ret['sub'] = sub;
                                        sortMenuData.push(ret);
                                    }
                                    ret = findClassItem(WebStack["Class"], itemName);
                                    if(ret != null) {
                                        sortClassData.push(ret);
                                    }
                                }
                            }
                        }
                        // console.log(sortMenuData, sortClassData);
                        let class_data = {
                            sort: JSON.stringify(sortData),
                            webStack: JSON.stringify({"Menu": sortMenuData, "Class": sortClassData}),
                        }
                        submit("?cmd=class-sort", class_data, function (res) {
                            // console.log(res);
                            $btn.button('reset');
                            if (res['error'] === 0) {
                                message('成功', res['message'], function () {
                                    reload();
                                });
                            } else {
                                message('错误', res['message']);
                            }
                        });
                    });
                </script>
            </div>
            <div class="page" id="web-config" style="display: none;">
                <div class="page-title">
                    <div class="title-env">
                        <h1 class="title">网址管理</h1>
                        <p class="description">所有导航网站信息列表</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 col-md-offset-9">
                        <button class="btn btn-block btn-icon btn-secondary btn-warning pull-right btn-lg" data-toggle="modal" data-target="#modal-web-edit" data-backdrop="static" >
                            <i class="fa-plus"></i>&nbsp;&nbsp;添加网址
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <ul class="nav nav-tabs">
                        {{range $index,$menu := .webstack.Menu}}
                            {{if eq $menu.Menu "smooth"}}
                            <li {{if eq $index 0}}class="active"{{end}}>
                                <a href="#webstack-class-{{$index}}" data-toggle="tab">{{$menu.Name}}</a>
                            </li>
                            {{end}}
                        {{end}}
                        </ul>
                        <div class="tab-content">
                        {{range $index,$menu := .webstack.Menu}}
                            {{if eq $menu.Menu "smooth"}}
                                <div class="tab-pane {{if eq $index 0}}active{{end}}" id="webstack-class-{{$index}}">
                                    <table class="table table-hover members-table middle-align">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th></th>
                                            <th>名称简介</th>
                                            <th class="hidden-xs hidden-sm">链接</th>
                                            <th class="hidden-xs hidden-sm">分类</th>
                                            <th class="text-center" style="width: 100px;">操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                    <div class="members-table-actions">
                                        <a href="javascript:void(0);" onclick="webstack_select_all({{$index}});" class="add">全选</a>
                                        <div class="selected-items">
                                            已选中 <span id="webstack-class-selected-{{$index}}">0</span> 个项目
                                        </div>
                                        <div class="selected-actions">
                                            <a href="javascript:void(0);" onclick="webstack_delete_select({{$index}});" class="delete">删除</a>
                                        </div>
                                    </div>
                                </div>
                            {{end}}
                        {{end}}
                            <script type="text/javascript">
                                function webstack_select_all(class_id) {
                                    if ($("#webstack-class-" + class_id + " a.add").text() == "全选") {
                                        $("#webstack-class-" + class_id + " input.cbr").prop("checked", true);
                                        $("#webstack-class-" + class_id + " a.add").text("反全选");
                                        $("#webstack-class-selected-" + class_id).text($("#webstack-class-" + class_id + " input.cbr").size());
                                    } else {
                                        $("#webstack-class-" + class_id + " input.cbr").prop("checked", false);
                                        $("#webstack-class-" + class_id + " a.add").text("全选");
                                        $("#webstack-class-selected-" + class_id).text("0");
                                    }
                                }

                                function webstack_delete_select(class_id) {
                                    let cbrWeb = $("#webstack-class-" + class_id + " input.cbr:checked").toArray();
                                    if (cbrWeb.length <= 0){
                                        return;
                                    }
                                    message("批量删除", "您正在执行批量删除功能，请确认将选中的" + cbrWeb.length + "个网址彻底删除，删除后将无法恢复！", function (ret) {
                                        if (ret == "ok") {
                                            var indexArray = new Array();
                                            for (let i=0;i<cbrWeb.length;i++) {
                                                indexArray.push(cbrWeb[i].value);
                                            }
                                            indexArray = indexArray.reverse();
                                            console.log(indexArray);
                                            webstackDeleteSubmit(indexArray, function (res) {
                                                reload();
                                                // if (res['error'] === 0) {
                                                //     message('成功', res['message'], function () {
                                                //         reload();
                                                //     });
                                                // } else {
                                                //     message('错误', res['message']);
                                                // }
                                            })
                                        }
                                    })
                                }
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page" id="stack-config" style="display: none;">
                <div class="page-title">
                    <div class="title-env">
                        <h1 class="title">网站配置</h1>
                        <p class="description">网站基本信息配置</p>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">基本信息</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="webTitle" class="col-sm-2 control-label">网站标题</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="webTitle" placeholder="输入网站标题" value="{{.config.Title}}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="webDescription" class="col-sm-2 control-label">网站描述</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" rows="3" id="webDescription" placeholder="输入网站描述">{{.config.Description}}</textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="webKeywords" class="col-sm-2 control-label">网站关键字</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" rows="4" id="webKeywords" placeholder="输入网站关键字">{{.config.Keywords}}</textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">底部信息</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="webRecordcode" class="col-sm-2 control-label">网站备案</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="webRecordcode" placeholder="输入网站备案号" value="{{.config.Recordcode}}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="webFooter" class="col-sm-2 control-label">版权信息</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" rows="5" id="webFooter" placeholder="输入网站版权信息">{{.config.Footer}}</textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">网站入口（重启后生效）</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="webUrl" class="col-sm-2 control-label">网站域名</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="webUrl" placeholder="输入网站域名" value="{{.config.Url}}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="webPort" class="col-sm-2 control-label">网站端口</label>
                                <div class="col-sm-9">
                                    <input type="number" class="form-control" id="webPort" placeholder="输入网站端口" value="{{.config.Port}}" required>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-10 col-sm-2">
                        <button type="button" id="webSaveSubmit" class="btn btn-info btn-block" data-loading-text="保存中...">保存</button>
                    </div>
                </div>
                <script type="text/javascript">
                    $("#webSaveSubmit").on('click', function () {
                        let $btn = $(this).button('loading');
                        let web_data = {
                            title: $("#webTitle").val(),
                            description: $("#webDescription").val(),
                            keywords: $("#webKeywords").val(),
                            recordcode: $("#webRecordcode").val(),
                            footer: $("#webFooter").val(),
                            url: $("#webUrl").val(),
                            port: $("#webPort").val(),
                        }
                        submit("?cmd=stack", web_data, function (res) {
                            $btn.button('reset');
                            if (res['error'] === 0) {
                                message('成功', res['message'], function () {
                                    reload();
                                });
                            } else {
                                message('错误', res['message']);
                            }
                        });
                    })
                </script>
            </div>
            <div class="page" id="user-config" style="display: none;">
                <div class="page-title">
                    <div class="title-env">
                        <h1 class="title">用户设置</h1>
                        <p class="description">设置管理员登陆信息</p>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">后台用户</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="adminUsername" class="col-sm-2 control-label">登陆账号</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="adminUsername" placeholder="输入新登陆账号" value="{{.login.Username}}" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="amdinPassword" class="col-sm-2 control-label">登陆密码</label>
                                <div class="col-sm-9">
                                    <input type="password" class="form-control" id="amdinPassword" placeholder="输入新登陆密码" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="amdinPassword2" class="col-sm-2 control-label">确认密码</label>
                                <div class=" col-sm-9">
                                    <input type="password" class="form-control" id="amdinPassword2" placeholder="再次输入新登陆密码" >
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-offset-9 col-sm-2">
                                    <button type="button" id="adminUserSubmit" class="btn btn-success btn-block" data-loading-text="加载中...">修改</button>
                                </div>
                            </div>
                            <script type="text/javascript">
                                $("#adminUserSubmit").on('click', function () {
                                    let $btn = $(this).button('loading');
                                    let user_data = {
                                        username: $("#adminUsername").val(),
                                        password: $("#amdinPassword").val(),
                                        password2: $("#amdinPassword2").val(),
                                    }
                                    submit("?cmd=user", user_data, function (res) {
                                        $btn.button('reset');
                                        if (res['error'] === 0) {
                                            message('成功', res['message'], function () {
                                                logout();
                                            });
                                        } else {
                                            message('错误', res['message']);
                                        }
                                    });
                                })
                            </script>
                        </form>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">后台入口</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="adminLogin" class="col-sm-2 control-label">登陆入口</label>
                                <div class="col-sm-6 col-md-7">
                                    <input type="text" class="form-control" id="adminLogin" placeholder="输入新登陆入口" value="{{.login.Path}}">
                                </div>
                                <div class="visible-xs"><br></div>
                                <div class="col-sm-3 col-md-2">
                                    <button type="button" id="adminLoginSubmit" class="btn btn-info btn-block" data-loading-text="加载中...">修改入口</button>
                                </div>
                            </div>
                            <script type="text/javascript">
                                $("#adminLoginSubmit").on('click', function () {
                                    let $btn = $(this).button('loading');
                                    let path = $("#adminLogin").val();
                                    submit("?cmd=login_path",{path: path}, function (res) {
                                        $btn.button('reset');
                                        if (res['error'] === 0) {
                                            message('成功', res['message'], function () {
                                                reload();
                                            });
                                        } else {
                                            message('错误', res['message'], function () {
                                                $("#adminLogin").focus();
                                            });
                                        }
                                    });
                                })
                            </script>
                        </form>
                    </div>
                </div>
            </div>

            <footer class="main-footer fixed footer-type-1">
                <div class="footer-inner">

                    <!-- Add your copyright text here -->
                    <div class="footer-text"></div>
                    <!-- Go to Top Link, just add rel="go-top" to any link to add this functionality -->
                    <div class="go-up">
                        <a href="http://beian.miit.gov.cn" target="_blank" style="background-color: unset;">
                            {{.config.Recordcode}}
                        </a>
                        <a href="#" target="_blank" rel="go-top">
                            <i class="fa-angle-up"></i>
                        </a>
                    </div>
                </div>
                <script type="text/javascript">
                    $(document).ready(function() {
                        $(".footer-text").html({{.config.Footer}});
                    })
                </script>
            </footer>
        </div>
    </div>
    <!-- 删除分类Modal -->
    <div class="modal fade" id="modal-class-delete">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">删除分类</h4>
                </div>
                <div class="modal-body">
                    <div class="" id="delete-message" style="width: 100%"></div>
                    <input type="hidden" id="class-delete-index" value="">
                </div>
                <div class="modal-footer">
                    <div class="pull-left text-danger">注意：删除后将无法恢复，建议备份后删除！</div>
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="classDeleteSubmit" data-loading-text="删除中...">删除</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            function classDeleteSubmit(index, callback = null) {
                let deleteData = {};
                deleteData['index'] = index;
                submit("?cmd=class-delete", deleteData, function (res) {
                    if (callback) {
                        callback(res);
                    }
                });
            }

            $("#classDeleteSubmit").on('click', function () {
                let $btn = $(this).button('loading');
                let modal = $("#modal-class-delete");
                classDeleteSubmit(modal.find('.modal-body #class-delete-index').val(), function (res) {
                    $btn.button('reset');
                    console.log(res);
                    if (res['error'] === 0) {
                        message('成功', res['message'], function () {
                            reload();
                        });
                    } else {
                        message('错误', res['message']);
                    }
                });
            });
        </script>
    </div>
    <!-- 编辑分类Modal -->
    <div class="modal fade" id="modal-class-edit">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">编辑分类</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group" style="margin-bottom: 0px;">
                                <div class="row">
                                    <div class="col-md-6" style="margin-bottom: 15px;">
                                        <label for="web-name" class="control-label">分类名称</label>
                                        <input type="text" class="form-control" id="class-name" placeholder="网站名称">
                                        <input type="hidden"id="class-id" value="-1">
                                    </div>
                                    <div class="col-md-6" style="margin-bottom: 15px;">
                                        <label class="control-label">分类图标</label>
                                        <div class="input-group">
                                            <div class="input-group-addon"><i class=""></i></div>
                                            <select class="form-control" name="select_class" id="select-class-icon">
                                                <option value="">无图标</option>
                                            </select>
                                        </div>
                                    </div>
                                    <script type="text/javascript">
                                        $(document).ready(function() {
                                            $("#select-class-icon").change(function(){
                                                const icon = $(this).children('option:selected').val();
                                                $("#select-class-icon").prev().find("i").attr("class", icon);
                                            });

                                            setTimeout(function () {
                                                $.getJSON("assets/json/icon.json","",function (result) {
                                                    if (result) {
                                                        let iconSelect = $("#select-class-icon");
                                                        iconSelect.find('option').remove();
                                                        iconSelect.append('<option value="">无图标</option>');
                                                        for (const icon in result) {
                                                            iconSelect.append('<option value="'+icon+'"><i class="'+icon+'"></i>'+result[icon]+'</option>');
                                                        }
                                                    }
                                                });
                                            }, 300);
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="control-label">上层分类</label>
                                        <select class="form-control" name="select_class" id="select-up-class">
                                            <option value="-1">顶层分类</option>
                                            {{range $index,$menu := .webstack.Menu}}
                                                {{if eq $menu.Menu "smooth"}}
                                                    <option value="{{$index}}">{{$menu.Name}}</option>
                                                {{end}}
                                            {{end}}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info" id="classSaveSubmit" data-loading-text="保存中...">保存</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $("#classSaveSubmit").on('click', function () {
                let $btn = $(this).button('loading');
                let modal = $("#modal-class-edit");
                let title = modal.find('.modal-title').text();
                if (title.indexOf("添加") >= 0) {
                    console.log(title, true);
                    classAddSubmit(modal, function (res) {
                        $btn.button('reset');
                        classSaveSubmitCallback(res);
                    });
                } else {
                    console.log(title, false);
                    classEditSubmit(modal, function (res) {
                        $btn.button('reset');
                        classSaveSubmitCallback(res);
                    });
                }
            });

            function classSaveSubmitCallback(res) {
                if (res['error'] === 0) {
                    message('成功', res['message'], function () {
                        reload();
                    });
                } else {
                    message('错误', res['message']);
                }
            }

            function classAddSubmit(modal, callback) {
                let addData = {
                    name: modal.find('.modal-body #class-name').val(),
                    icon: modal.find('.modal-body #select-class-icon option:selected').val(),
                    class_up: modal.find('.modal-body #select-up-class option:selected').val(),
                    class_id: modal.find('.modal-body #class-id').val(),
                }
                console.log(addData);
                submit("?cmd=class-add", addData, function (res) {
                    //console.log(res);
                    callback(res);
                });
            }

            function classEditSubmit(modal, callback) {
                let editData = {
                    name: modal.find('.modal-body #class-name').val(),
                    icon: modal.find('.modal-body #select-class-icon option:selected').val(),
                    class_up: modal.find('.modal-body #select-up-class option:selected').val(),
                    class_id: modal.find('.modal-body #class-id').val(),
                }
                console.log(editData);
                submit("?cmd=class-edit", editData, function (res) {
                    callback(res);
                });
            }
        </script>
    </div>
    <!-- 删除网站Modal -->
    <div class="modal fade" id="modal-web-delete">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">删除网站</h4>
                </div>
                <div class="modal-body">
                    <div class="" id="delete-message" style="width: 100%"></div>
                    <input type="hidden" id="web-delete-index" value="">
                </div>
                <div class="modal-footer">
                    <div class="pull-left text-danger">注意：删除后将无法恢复，建议备份后删除！</div>
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="webstackDeleteSubmit" data-loading-text="删除中...">删除</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            function webstackDeleteSubmit(index, callback = null) {
                let deleteData = {};
                if (Array.isArray(index) === true) {
                    deleteData['indexArray'] = JSON.stringify(index);
                } else {
                    deleteData['index'] = index;
                }
                submit("?cmd=web-delete", deleteData, function (res) {
                    if (callback) {
                        callback(res);
                    }
                });
            }

            $("#webstackDeleteSubmit").on('click', function () {
                let $btn = $(this).button('loading');
                let modal = $("#modal-web-delete");
                webstackDeleteSubmit(modal.find('.modal-body #web-delete-index').val(), function (res) {
                    $btn.button('reset');
                    console.log(res);
                    if (res['error'] === 0) {
                        message('成功', res['message'], function () {
                            reload();
                        });
                    } else {
                        message('错误', res['message']);
                    }
                });
            });
        </script>
    </div>
    <!-- 编辑网站Modal -->
    <div class="modal fade" id="modal-web-edit">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">编辑网站</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <script type="text/javascript">
                        jQuery(document).ready(function($) {
                            var modal = $('#modal-web-edit');
                            $("#web-image").dropzone({
                                url: '/admin/upload',
                                // Events
                                addedfile: function(file) {
                                    console.log(file);
                                    modal.find('.modal-body #web-image').css('background-image', 'none');
                                    modal.find('.modal-body #web-image').text("准备上传");

                                    let size = parseInt(file.size / 1024, 10);
                                    size = size < 1024 ? (size + " KB") : (parseInt(size / 1024, 10) + " MB");
                                    console.log(size);
                                },

                                uploadprogress: function(file, progress, bytesSent) {
                                    console.log(file, progress, bytesSent);
                                    modal.find('.modal-body #web-image').text("上传中 (" + progress + "%)");
                                    //file.progressBar.width(progress + '%');
                                },

                                success: function(file) {
                                    let res = JSON.parse(file.xhr.response);
                                    console.log(file, res);
                                    if (res.error == 0) {
                                        modal.find('.modal-body #web-image').text("");
                                        modal.find('.modal-body #web-image-url').val(res.url);
                                        modal.find('.modal-body #web-image').css('background-image', 'url('+res.url+')');
                                    } else {
                                        modal.find('.modal-body #web-image').text("上传失败");
                                        message("上传失败", res.message, function () {
                                            let url = modal.find('.modal-body #web-image-url').val();
                                            console.log(url);
                                            if (url == ""){
                                                modal.find('.modal-body #web-image').text("重新选择图片");
                                                modal.find('.modal-body #web-image').css('background-image', 'none');
                                            } else {
                                                modal.find('.modal-body #web-image').text("");
                                                modal.find('.modal-body #web-image').css('background-image', 'url('+url+')');
                                            }
                                        });
                                    }
                                    // file.fileEntryTd.find('td:last').html('<span class="text-success">Uploaded</span>');
                                    // file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-success');
                                },

                                error: function(file) {
                                    console.log(file);
                                    modal.find('.modal-body #web-image').text("上传失败");
                                    // file.fileEntryTd.find('td:last').html('<span class="text-danger">Failed</span>');
                                    // file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-red');
                                }
                            });
                            $("#web-file-upload").dropzone({
                                url: '/admin/uploadfile',
                                // Events
                                addedfile: function(file) {
                                    console.log(file);
                                    let size = parseInt(file.size / 1024, 10);
                                    size = size < 1024 ? (size + " KB") : (parseInt(size / 1024, 10) + " MB");
                                    console.log(size);
                                },

                                uploadprogress: function(file, progress, bytesSent) {
                                    console.log(file, progress, bytesSent);
                                },

                                success: function(file) {
                                    let res = JSON.parse(file.xhr.response);
                                    console.log(file, res);
                                    if (res.error == 0) {
                                        modal.find('.modal-body #web-url').val(res.url);
                                    } else {
                                        message("上传失败");
                                    }
                                    // file.fileEntryTd.find('td:last').html('<span class="text-success">Uploaded</span>');
                                    // file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-success');
                                },

                                error: function(file) {
                                    console.log(file);
                                    message("上传失败");
                                    // file.fileEntryTd.find('td:last').html('<span class="text-danger">Failed</span>');
                                    // file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-red');
                                }
                            });
                        });
                        </script>
                        <div class="col-md-12">
                            <div class="col-sm-4 text-center">
                                <input type="hidden" id="web-image-url" value="">
                                <div id="web-image" class="droppable-area">
                                    选择图片
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="web-name" class="control-label">名称</label>
                                            <input type="text" class="form-control" id="web-name" placeholder="网站名称">
                                            <input type="hidden" id="web-index" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label">分类</label>
                                            <div class="row">
                                                <div class="col-md-6" style="margin-bottom: 10px;">
                                                    <select class="form-control" name="select_class" id="select-class-1">
                                                    {{range $index,$menu := .webstack.Menu}}
                                                        {{if eq $menu.Menu "smooth"}}
                                                        <option value="{{$index}}">{{$menu.Name}}</option>
                                                        {{end}}
                                                    {{end}}
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <select class="form-control col-md-6" name="select_class" id="select-class-2" style="display: none;"></select>
                                                </div>
                                                <script type="text/javascript">
                                                    function showSelectClass2(index, value=false) {
                                                        let menuSub = WebStack['Menu'][index]['sub'];
                                                        $("#select-class-2").find('option').remove();
                                                        if (menuSub.length > 0) {
                                                            $("#select-class-2").show();
                                                            for (let i=0; i<menuSub.length; i++) {
                                                                $("#select-class-2").append('<option class="select-menu-sub select-menu-sub-'+index+'" value="'+index+'-'+i+'">'+menuSub[i]['name']+'</option>');
                                                            }
                                                            if (value !== false) {
                                                                $("#select-class-2").find('option[value="'+index+'-'+value+'"]').attr("selected",true);
                                                            }
                                                        } else {
                                                            $("#select-class-2").hide();
                                                            $("#select-class-2").empty();
                                                        }
                                                    }

                                                    jQuery(document).ready(function($)
                                                    {
                                                        $("#select-class-1").change(function(){
                                                            const id = $(this).children('option:selected').val();
                                                            showSelectClass2(id, 0);
                                                            console.log($("#select-class-1").val());
                                                        });
                                                        $("#select-class-2").change(function(){
                                                            console.log($("#select-class-2").val());
                                                        });
                                                    });
                                                </script>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <button type="button" id="web-file-upload" class="btn btn-white" >点击上传附件</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="padding-left: 15px; padding-right: 15px;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="web-url" class="control-label">网址</label>
                                <input type="text" class="form-control" id="web-url" placeholder="https://">
                            </div>
                        </div>
                    </div>
                    <div class="row" style="padding-left: 15px; padding-right: 15px;">
                        <div class="col-md-12">
                            <div class="form-group no-margin">
                                <label for="web-mark" class="control-label">简介</label>
                                <textarea class="form-control autogrow" id="web-mark" placeholder="对此网站的简介文字"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info" id="webstackSaveSubmit" data-loading-text="保存中...">保存</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $("#webstackSaveSubmit").on('click', function () {
                let $btn = $(this).button('loading');
                let modal = $("#modal-web-edit");
                let title = modal.find('.modal-title').text();
                if (title.indexOf("添加") >= 0) {
                    //console.log(title, true);
                    webstackAddSubmit(modal, function (res) {
                        $btn.button('reset');
                        webstackSaveSubmitCallback(res);
                    });
                } else {
                    //console.log(title, false);
                    webstackEditSubmit(modal, function (res) {
                        $btn.button('reset');
                        webstackSaveSubmitCallback(res);
                    });
                }
            });

            function webstackSaveSubmitCallback(res) {
                if (res['error'] === 0) {
                    message('成功', res['message'], function () {
                        reload();
                    });
                } else {
                    message('错误', res['message']);
                }
            }

            function webstackAddSubmit(modal, callback) {
                let addData = {
                    name: modal.find('.modal-body #web-name').val(), 
                    url: modal.find('.modal-body #web-url').val(),
                    mark: modal.find('.modal-body #web-mark').val(),
                    img: modal.find('.modal-body #web-image-url').val(),
                    class1_id: modal.find('.modal-body #select-class-1').val(),
                    class2_id: modal.find('.modal-body #select-class-2').val(),
                    class1_name: modal.find('.modal-body #select-class-1 option:selected').text(),
                    class2_name: modal.find('.modal-body #select-class-2 option:selected').text(),
                }
                //console.log(addData);
                submit("?cmd=web-add", addData, function (res) {
                    callback(res);
                });
            }

            function webstackEditSubmit(modal, callback) {
                let editData = {
                    index: modal.find('.modal-body #web-index').val(),
                    name: modal.find('.modal-body #web-name').val(),
                    url: modal.find('.modal-body #web-url').val(),
                    mark: modal.find('.modal-body #web-mark').val(),
                    img: modal.find('.modal-body #web-image-url').val(),
                    class1_id: modal.find('.modal-body #select-class-1').val(),
                    class2_id: modal.find('.modal-body #select-class-2').val(),
                    class1_name: modal.find('.modal-body #select-class-1 option:selected').text(),
                    class2_name: modal.find('.modal-body #select-class-2 option:selected').text(),
                }
                //console.log(editData);
                submit("?cmd=web-edit", editData, function (res) {
                    callback(res);
                });
            }

        </script>
    </div>
    <!-- 提示框Modal -->
    <div class="modal fade" id="modal-message" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-message-title"></h4>
                </div>
                <div class="modal-body">
                    <div class="" id="modal-message-text" style="width: 100%"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="modal-message-btn-ok">确定</button>
                    <button type="button" class="btn btn-white" id="modal-message-btn-close">关闭</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            function message(title, text="", callback=null) {
                var fn_close, fn_ok;
                $('#modal-message-title').text(title);
                $('#modal-message-text').text(text);
                $('#modal-message-btn-close').bind('click', fn_close = function () {
                    if (callback) callback('close');
                    $('#modal-message').modal('hide');
                    $('#modal-message-btn-close').unbind('click', fn_close);
                    $('#modal-message-btn-ok').unbind('click', fn_ok);
                });
                $('#modal-message-btn-ok').bind('click', fn_ok = function () {
                    if (callback) callback('ok');
                    $('#modal-message').modal('hide');
                    $('#modal-message-btn-close').unbind('click', fn_close);
                    $('#modal-message-btn-ok').unbind('click', fn_ok);
                });
                $('#modal-message').modal('show');
            }
        </script>
    </div>
    <!-- Imported styles on this page -->
    <link rel="stylesheet" href="assets/js/dropzone/css/dropzone.css">
    <!-- Imported scripts on this page -->
    <script src="assets/js/dropzone/dropzone.min.js"></script>
    <!-- Bottom Scripts -->
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/TweenMax.min.js"></script>
    <script src="assets/js/resizeable.js"></script>
    <script src="assets/js/joinable.js"></script>
    <script src="assets/js/xenon-api.js"></script>
    <script src="assets/js/xenon-toggles.js"></script>
    <!-- JavaScripts initializations and stuff -->
    <script src="assets/js/xenon-custom.js"></script>
    <script src="assets/js/sortable.min.js"></script>

    <script type="text/javascript">
    var WebStack;
    $(document).ready(function() {

        let m=window.location.hash.replace("#", "");
        if (m && $(".page[id="+m+"]").length > 0) {
            menu(m);
        }
        // console.log(m, $(".page[id="+m+"]").length);

        $.getJSON("?cmd=webstack.json","",function (result) {
            WebStack = result;
            for (let i=0; i<WebStack.Menu.length; i++) {
                let table = $("#webstack-class-" + i)
                const MenuName = WebStack.Menu[i].name;
                const MenuSub = WebStack.Menu[i].sub;
                if (table) {
                    let tbody = table.find("tbody")
                    tbody.empty();
                    if ( MenuSub.length > 0 ) {
                        for (let k=0; k<MenuSub.length; k++) {
                            const MenuSubName = MenuSub[k].name;
                            const rows = findWebClass(MenuSubName);
                            for (let j=0; j<rows.length; j++) {
                                addWebTableItem(tbody,rows[j],MenuSubName,i+'-'+k+'-'+j);
                            }
                        }
                    } else {
                        const rows = findWebClass(MenuName);
                        for (let j=0; j<rows.length; j++) {
                            addWebTableItem(tbody,rows[j],MenuName,i+'-'+j);
                        }
                    }
                }

            }
        });

        $(document).on('click', '.has-sub', function(){
            let that = $(this)
            let page = that.attr('data-page');
            menu(page);
        });

        $(".cbr").click(function() {
            if ($(this).is(":checked")== true) {
                //选中触发事件
                console.log($(this))
            } else {
                //取消选中触发事件
                console.log($(this))
            }
        });

        $('#modal-class-delete').on('show.bs.modal', function (event){
            let button = $(event.relatedTarget) // Button that triggered the modal
            let index = button.data('index') // Extract info from data-* attributes
            let modal = $(this)
            if (index) {
                let classIndex = 0;
                let classUpIndex = false;
                let menuClass = {};
                // console.log(index);
                if ((index + "").indexOf("-") > 0) {
                    let arrData = index.split("-");
                    classUpIndex = parseInt(arrData[0]);
                    classIndex = parseInt(arrData[1]);
                    menuClass = WebStack['Menu'][classUpIndex]['sub'][classIndex];
                } else {
                    classIndex = parseInt(index);
                    menuClass = WebStack['Menu'][classIndex];
                }
                modal.find('.modal-title').text("删除分类【"+menuClass['name']+"】");
                modal.find('.modal-body #class-delete-index').val(index);
                modal.find('.modal-body #delete-message').text("请谨慎决定是否要删除 【"+menuClass['name']+"】 分类及其该分类下的全部网站吗？");
            }
        });

        $('#modal-class-edit').on('show.bs.modal', function (event){
            let button = $(event.relatedTarget);
            let index = button.data('index');
            let type  = button.data('class');
            let modal = $(this)
            if (type == 'add') {
                modal.find('.modal-title').text("添加分类");
                modal.find(".modal-body #class-name").val("");
                modal.find(".modal-body #select-class-icon").val("");
                modal.find(".modal-body #select-up-class").val(index);
                modal.find(".modal-body #class-id").val(index);
            }
            if (type == 'edit') {
                let classIndex = 0;
                let classUpIndex = false;
                let menuClass = {};
                if ((index + "").indexOf("-") > 0) {
                    let arrData = index.split("-");
                    classUpIndex = parseInt(arrData[0]);
                    classIndex = parseInt(arrData[1]);
                    menuClass = WebStack['Menu'][classUpIndex]['sub'][classIndex];
                    modal.find("#select-up-class").val(classUpIndex);
                } else {
                    classIndex = parseInt(index);
                    menuClass = WebStack['Menu'][classIndex];
                    modal.find("#select-up-class").val("-1");
                }
                modal.find(".modal-body #class-id").val(index);
                modal.find('.modal-title').text("编辑分类【"+menuClass['name']+"】");
                modal.find(".modal-body #class-name").val(menuClass['name']);
                modal.find(".modal-body #select-class-icon").val(menuClass['icon']);
                $("#select-class-icon").prev().find("i").attr("class", menuClass['icon']);
            }
        });

        $('#modal-web-delete').on('show.bs.modal', function (event) {
            let button = $(event.relatedTarget) // Button that triggered the modal
            let index = button.data('index') // Extract info from data-* attributes
            let modal = $(this)
            if (index) {
                let arrData = index.split("-");
                let menuClass = WebStack['Menu'][arrData[0]];
                let menuName = menuClass['name'];
                if (arrData.length >= 3) {
                    menuName = menuClass['sub'][arrData[1]]['name'];
                }
                let webData = findWebClass(menuName)[arrData[arrData.length-1]];
                modal.find('.modal-title').text("删除网址【"+webData['name']+"】");
                modal.find('.modal-body #web-delete-index').val(index);
                modal.find('.modal-body #delete-message').text("请谨慎决定是否要删除 【"+webData['name']+"】 "+webData['url']+" 网址吗？");
            } else {
                modal.find('.modal-title').text("批量删除网址");
                modal.find('.modal-body #delete-message').text("您正在执行批量删除功能，请确认是否将选中的网址全部彻底删除？");
            }
        });

        $('#modal-web-edit').on('show.bs.modal', function (event) {
            let button = $(event.relatedTarget) // Button that triggered the modal
            let index = button.data('index') // Extract info from data-* attributes
            let modal = $(this)
            if (index) {
                let webIndex = 0;
                let menuName = "";
                let arrData = index.split("-");
                modal.find('.modal-title').text("编辑网站");
                if (arrData.length >= 2) {
                    var menuClass = WebStack['Menu'][arrData[0]];
                    menuName = menuClass['name'];
                    webIndex = arrData[1];
                    modal.find('.modal-body #select-class-1').val(arrData[0]);;
                    modal.find('.modal-body #select-class-2').val("");
                    showSelectClass2(arrData[0], arrData[1]);
                }
                if (arrData.length >= 3) {
                    var menuSubClass = menuClass['sub'][arrData[1]];
                    menuName = menuSubClass['name'];
                    webIndex = arrData[2];
                }
                let webData = findWebClass(menuName)[webIndex];
                modal.find('.modal-body #web-index').val(index);
                modal.find('.modal-body #web-name').val(webData['name']);
                modal.find('.modal-body #web-url').val(webData['url']);
                modal.find('.modal-body #web-mark').val(webData['mark']);
                modal.find('.modal-body #web-image-url').val(webData['img']);
                modal.find('.modal-body #web-image').css('background-image', 'url('+webData['img']+')');
                modal.find('.modal-body #web-image').text("");
            } else {
                modal.find('.modal-title').text("添加网站");
                modal.find('.modal-body #web-index').val("");
                modal.find('.modal-body #web-name').val("");
                modal.find('.modal-body #web-url').val("");
                modal.find('.modal-body #web-mark').val("");
                modal.find('.modal-body #web-image-url').val("");
                modal.find('.modal-body #web-image').css('background-image', 'none');
                modal.find('.modal-body #web-image').text("选择图片");
            }
            //console.log("modal-web-edit", index);
        })

        let nestedSortables = [].slice.call(document.querySelectorAll('.nested-sortable'));
        for (let i = 0; i < nestedSortables.length; i++) {
            SortClassData[i] = new Sortable(nestedSortables[i], {
                group: 'nested-'+i,
                animation: 150,
                delay: 300,
                fallbackOnBody: true,
                chosenClass: 'list-class-item-action', //选中样式
                // 列表内元素顺序更新的时候触发
                onUpdate: function (evt) {
                    // same properties as onEnd
                    $("#class-save-sort").show();
                },
                // // 元素被选中
                // onChoose: function (evt) {
                //     // console.log("元素被选中", evt.item);
                //     $(evt.item).addClass("list-class-item-action");
                // },
                //
                // // 元素未被选中的时候（从选中到未选中）
                // onUnchoose: function(evt) {
                //     // console.log("元素被释放", evt.item);
                //     $(evt.item).removeClass("list-class-item-action");
                // },
            });
        }
    });

    function findWebClass(MenuName) {
        for (let i=0; i<WebStack['Class'].length; i++) {
            if (WebStack['Class'][i].name == MenuName) {
                return WebStack['Class'][i].rows;
            }
        }
        return Array();
    }

    function checkWebClick(index) {
        let arrData = index.split("-");
        if (arrData.length > 0) {
            let arrCheck = Array();
            $(".cbr[value^='"+arrData[0]+"-']:checked").each(function (item) {//
                arrCheck.push($(this).val());
            });
            // console.log(index, arrCheck, arrCheck.length);
            $("#webstack-class-selected-"+arrData[0]).text(arrCheck.length);
        }
    }

    function addWebTableItem(tbody, webItem, menuName, index) {
        if (webItem.img == "") {
            webItem.img = "../assets/images/logos/null.png"
        }
        tbody.append('<tr> ' +
            '<td class="user-cb"><input type="checkbox" class="cbr" name="members-list[]" value="'+index+'" onclick="checkWebClick(\''+index+'\');" /></td>' +
            '<td class="user-image"><img src="'+ webItem.img +'" class="img-circle" alt="user-pic" /></td>' +
            '<td class="user-name"><span class="name">' + webItem.name +'</span><span class="hidden-xs">' + webItem.mark +'</span></td>' +
            '<td class="hidden-xs hidden-sm"><span class="email">' + webItem.url +'</span></td>' +
            '<td class="hidden-xs hidden-sm" style=" white-space:nowrap"><span class="email">'+menuName+'</span></td>' +
            '<td class="action-links text-center" style="width: auto;">' +
            '<button type="button" id="btn-web-edit" class="btn btn-success btn-xs" data-toggle="modal" data-target="#modal-web-edit" data-backdrop="static" data-index="'+index+'"><i class="linecons-pencil"></i>编辑</button>' +
            '<button type="button" id="btn-web-delete" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#modal-web-delete" data-backdrop="static" data-index="'+index+'"><i class="linecons-trash"></i>删除</button>' +
            '</td>' +
            '</tr>');
    }

    function menu(page) {
        $(".page").hide();
        $(".has-sub").removeClass("active");
        $("#"+page).show();
        $("#menu-"+page).addClass("active");
    }
    
    function submit(url, data, callback) {
        $.ajax({
            url: url,
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(res){
                console.log(res);
                if (callback) {
                    callback(res);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error(jqXHR, textStatus, errorThrown);
                if (textStatus == "error" && errorThrown == "Unauthorized") {
                    message("错误 "+jqXHR.status, "发送命令失败，当前环境授权超时或未授权发送命令，请重新登陆再试。", function () {
                        $(location).attr('href', '/');
                    });
                } else {
                    message("错误 "+jqXHR.status, textStatus + "：" + errorThrown);
                }
            }
        });
    }

    function reload() {
        location.reload();
    }

    function logout() {
        $.get("?cmd=logout", function (res) {
            console.log(res);
            $(location).attr('href', '/');
        }).fail(function () {
            $(location).attr('href', '/');
        });
    }
    </script>
</body>

</html>
{{end}}
